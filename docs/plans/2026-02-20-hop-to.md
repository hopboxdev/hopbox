# hop to Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Rewrite `hop to` so it accepts SSH credentials, bootstraps the target inline, migrates data via a temporary WireGuard tunnel, and switches the default host — all in one command.

**Architecture:** `to.go` is rewritten entirely. It reuses `setup.Bootstrap()`, `tunnel.NewClientTunnel`, and `rpcclient.CallVia` — no changes to internal packages. `probeAgent` is already in `main.go` and available to all command files.

**Tech Stack:** Go, `internal/setup`, `internal/tunnel`, `internal/rpcclient`, `internal/hostconfig`

---

### Task 1: Add SSH flags to ToCmd

**Files:**
- Modify: `cmd/hop/to.go`

The current `ToCmd` only has a `Target` arg. Add SSH flags matching `SetupCmd`.

**Step 1: Replace the struct definition**

Open `cmd/hop/to.go`. Replace the entire file with this skeleton (we'll fill `Run` in the next task):

```go
package main

import (
	"bufio"
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"os"
	"os/signal"
	"strings"
	"syscall"

	"github.com/hopboxdev/hopbox/internal/hostconfig"
	"github.com/hopboxdev/hopbox/internal/rpcclient"
	"github.com/hopboxdev/hopbox/internal/setup"
	"github.com/hopboxdev/hopbox/internal/tunnel"
)

// ToCmd migrates the workspace to a new host.
type ToCmd struct {
	Target string `arg:"" help:"Name for the target host."`
	Addr   string `short:"a" required:"" help:"Remote SSH host IP or hostname."`
	User   string `short:"u" default:"root" help:"SSH username."`
	SSHKey string `short:"k" help:"Path to SSH private key."`
	Port   int    `short:"p" default:"22" help:"SSH port."`
}

func (c *ToCmd) Run(globals *CLI) error {
	return fmt.Errorf("not yet implemented")
}
```

**Step 2: Verify it builds**

```bash
go build ./cmd/hop/...
```

Expected: success (no errors).

**Step 3: Commit**

```bash
git add cmd/hop/to.go
git commit -m "feat: add SSH flags to ToCmd skeleton"
```

---

### Task 2: Add confirmation prompt

**Files:**
- Modify: `cmd/hop/to.go`

**Step 1: Replace `Run` with confirmation logic**

Replace the `Run` method body with:

```go
func (c *ToCmd) Run(globals *CLI) error {
	ctx, cancel := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM)
	defer cancel()

	sourceHost, err := resolveHost(globals)
	if err != nil {
		return fmt.Errorf("source host: %w", err)
	}
	if c.Target == sourceHost {
		return fmt.Errorf("target host must differ from source host")
	}

	// Show confirmation prompt before any work begins.
	fmt.Printf("Migrate workspace from %s → %s (%s)?\n", sourceHost, c.Target, c.Addr)
	fmt.Println("  1. Create snapshot on", sourceHost)
	fmt.Println("  2. Bootstrap", c.Target, "via SSH")
	fmt.Println("  3. Restore snapshot on", c.Target)
	fmt.Println("  4. Set", c.Target, "as default host")
	fmt.Print("\nProceed? [y/N] ")
	scanner := bufio.NewScanner(os.Stdin)
	if !scanner.Scan() || strings.ToLower(strings.TrimSpace(scanner.Text())) != "y" {
		fmt.Println("Aborted.")
		return nil
	}

	_ = ctx
	return fmt.Errorf("rest not yet implemented")
}
```

**Step 2: Build**

```bash
go build ./cmd/hop/...
```

Expected: success.

**Step 3: Commit**

```bash
git add cmd/hop/to.go
git commit -m "feat: add hop to confirmation prompt"
```

---

### Task 3: Implement Step 1 — snapshot source

**Files:**
- Modify: `cmd/hop/to.go`

**Step 1: Replace the stub at the end of `Run` with snapshot logic**

Remove `_ = ctx` and `return fmt.Errorf("rest not yet implemented")`. Replace with:

```go
	// Step 1/4: Snapshot source.
	fmt.Printf("\nStep 1/4  Snapshot  creating snapshot on %s...\n", sourceHost)
	snapResult, err := rpcclient.Call(sourceHost, "snap.create", nil)
	if err != nil {
		return fmt.Errorf("create snapshot on %s: %w", sourceHost, err)
	}
	var snap struct {
		SnapshotID string `json:"snapshot_id"`
	}
	if err := json.Unmarshal(snapResult, &snap); err != nil || snap.SnapshotID == "" {
		return fmt.Errorf("could not parse snapshot ID from response: %s", string(snapResult))
	}
	fmt.Printf("            snapshot %s created.\n", snap.SnapshotID)

	return fmt.Errorf("steps 2-4 not yet implemented")
```

**Step 2: Build**

```bash
go build ./cmd/hop/...
```

Expected: success.

**Step 3: Commit**

```bash
git add cmd/hop/to.go
git commit -m "feat: hop to step 1 — snapshot source"
```

---

### Task 4: Implement Step 2 — bootstrap target

**Files:**
- Modify: `cmd/hop/to.go`

**Step 1: Replace the trailing stub with bootstrap logic**

Remove `return fmt.Errorf("steps 2-4 not yet implemented")`. Replace with:

```go
	// Step 2/4: Bootstrap target.
	fmt.Printf("\nStep 2/4  Bootstrap  setting up %s...\n", c.Target)
	targetCfg, err := setup.Bootstrap(ctx, setup.Options{
		Name:       c.Target,
		SSHHost:    c.Addr,
		SSHPort:    c.Port,
		SSHUser:    c.User,
		SSHKeyPath: c.SSHKey,
	}, os.Stdout)
	if err != nil {
		return fmt.Errorf("bootstrap %s: %w", c.Target, err)
	}
	fmt.Printf("            %s bootstrapped.\n", c.Target)

	return fmt.Errorf("steps 3-4 not yet implemented")
	_ = targetCfg
```

Note: `targetCfg` is used in step 3; the blank identifier keeps the compiler happy in the interim.

**Step 2: Build**

```bash
go build ./cmd/hop/...
```

Expected: success.

**Step 3: Commit**

```bash
git add cmd/hop/to.go
git commit -m "feat: hop to step 2 — bootstrap target"
```

---

### Task 5: Implement Step 3 — restore via temporary tunnel

**Files:**
- Modify: `cmd/hop/to.go`

**Step 1: Replace the trailing stub with tunnel + restore logic**

Remove the two lines `return fmt.Errorf("steps 3-4 not yet implemented")` and `_ = targetCfg`. Replace with:

```go
	// Step 3/4: Restore via temporary WireGuard tunnel.
	fmt.Printf("\nStep 3/4  Restore    connecting to %s...\n", c.Target)
	tunCfg, err := targetCfg.ToTunnelConfig()
	if err != nil {
		return fmt.Errorf("build tunnel config: %w", err)
	}
	tun := tunnel.NewClientTunnel(tunCfg)

	tunCtx, tunCancel := context.WithTimeout(ctx, 5*60*1e9) // 5 minutes
	defer tunCancel()
	go func() { _ = tun.Start(tunCtx) }()

	agentClient := &http.Client{
		Timeout:   agentClientTimeout,
		Transport: &http.Transport{DialContext: tun.DialContext},
	}
	agentURL := fmt.Sprintf("http://%s:%d/health", targetCfg.AgentIP, tunnel.AgentAPIPort)
	if err := probeAgent(ctx, agentURL, agentProbeTimeout, agentClient); err != nil {
		return fmt.Errorf("target agent unreachable after bootstrap: %w", err)
	}

	fmt.Printf("            restoring snapshot %s...\n", snap.SnapshotID)
	if _, err := rpcclient.CallVia(agentClient, c.Target, "snap.restore", map[string]string{"id": snap.SnapshotID}); err != nil {
		fmt.Fprintf(os.Stderr, "\nRestore failed. To retry manually:\n")
		fmt.Fprintf(os.Stderr, "  hop snap restore %s --host %s\n", snap.SnapshotID, c.Target)
		return fmt.Errorf("restore on %s: %w", c.Target, err)
	}
	fmt.Printf("            snapshot restored.\n")

	return fmt.Errorf("step 4 not yet implemented")
```

Note: `agentClientTimeout` and `agentProbeTimeout` are the constants already defined in `up.go` (`5*time.Second` and `10*time.Second` respectively). They are package-level in the same `main` package and accessible here.

**Step 2: Build**

```bash
go build ./cmd/hop/...
```

Expected: success.

**Step 3: Commit**

```bash
git add cmd/hop/to.go
git commit -m "feat: hop to step 3 — restore via temporary tunnel"
```

---

### Task 6: Implement Step 4 — switch default host

**Files:**
- Modify: `cmd/hop/to.go`

**Step 1: Replace the trailing stub with default-host switch**

Remove `return fmt.Errorf("step 4 not yet implemented")`. Replace with:

```go
	// Step 4/4: Switch default host.
	fmt.Printf("\nStep 4/4  Switch     setting default host to %s...\n", c.Target)
	if err := hostconfig.SetDefaultHost(c.Target); err != nil {
		return fmt.Errorf("set default host: %w", err)
	}

	fmt.Printf("\nMigration complete. Default host set to %q.\n", c.Target)
	fmt.Printf("Run 'hop up' to connect to %s.\n", c.Target)
	return nil
```

**Step 2: Build**

```bash
go build ./cmd/hop/...
```

Expected: success.

**Step 3: Run the full test suite**

```bash
go test ./...
```

Expected: all tests pass (we haven't changed any internal packages).

**Step 4: Commit**

```bash
git add cmd/hop/to.go
git commit -m "feat: hop to step 4 — switch default host; complete implementation"
```

---

### Task 7: Final review and cleanup

**Files:**
- Modify: `cmd/hop/to.go`

**Step 1: Check the 5-minute timeout constant**

The tunnel context timeout `5*60*1e9` is a raw nanosecond literal. Replace with the idiomatic form:

Find:
```go
tunCtx, tunCancel := context.WithTimeout(ctx, 5*60*1e9) // 5 minutes
```

Replace with:
```go
tunCtx, tunCancel := context.WithTimeout(ctx, 5*time.Minute)
```

Add `"time"` to the import block if not already present.

**Step 2: Build and test**

```bash
go build ./cmd/hop/...
go test ./...
```

Expected: both pass.

**Step 3: Lint**

```bash
golangci-lint run ./cmd/hop/...
```

Expected: no issues (fix any that appear before committing).

**Step 4: Final commit**

```bash
git add cmd/hop/to.go
git commit -m "refactor: use time.Minute constant in hop to tunnel timeout"
```
